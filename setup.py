# -*- coding: utf-8 -*-
from setuptools import setup

package_dir = \
{'': 'src'}

packages = \
['himut']

package_data = \
{'': ['*']}

install_requires = \
['argparse>=1.4.0,<2.0.0',
 'biopython>=1.78,<2.0',
 'cyvcf2>=0.30.18,<0.31.0',
 'natsort>=8.0.0,<9.0.0',
 'numpy>=1.20.2,<2.0.0',
 'plotnine>=0.9.0,<0.10.0',
 'psutil>=5.8.0,<6.0.0',
 'pyfastx>=0.8.4,<0.9.0',
 'pyproject-toml>=0.0.10,<0.0.11',
 'pysam>=0.18.0,<0.19.0',
 'pytabix>=0.1,<0.2']

entry_points = \
{'console_scripts': ['himut = himut.__main__:main']}

setup_kwargs = {
    'name': 'himut',
    'version': '1.0.1',
    'description': 'himut: single molecule somatic single-base substitution detection using PacBio CCS reads',
    'long_description': '## <a name="started"></a>Getting started\n\n```sh\n## pip installation\npip install himut\n\n## download and install the latest release\nwget https://github.com/sjin09/himut/archive/refs/tags/v1.0.0.tar.gz\ntar -zxvf v1.0.0.tar.gz\ncd himut-1.0.0\nbash install.sh\n\n## use miniamp2 and samtools to align, sort (and merge) PacBio CCS read alignments\nminimap2 "@RG\\tSM:sample" -ax map-hifi --cs ref.fa pacbio.ccs.fastq.gz | samtools sort -o aln.sorted.bam # SM tag must be provided to retrieve sample ID\nsamtools view -bh -F 0x900 aln.sorted.bam > aln.primary_alignments.sorted.bam # select primary alignments\nsamtools index aln.primary_alignments.sorted.bam\nsamtools merge *.primary_alignments.sorted.bam | samtools sort -o aln.primary_alignments.mergeSorted.bam -\nsamtools index aln.primary_alignments.mergeSorted.bam \n\n## use deepvariant to call germline mutations\ndeepvariant.simg /opt/deepvariant/bin/run_deepvariant --model_type=PACBIO --ref ref.fa --reads=aln.primary_alignments.sorted.bam --output_vcf=germline.vcf\n\n## use himut to call somatic mutations \nhimut call -i aln.primary_alignments.sorted.bam --vcf germline.vcf -o somatic.vcf --non_human_sample\nhimut call -i aln.primary_alignments.sorted.bam --vcf germline.vcf --common_snps ALL.wgs.phase3_shapeit2_mvncall_integrated_v5b.20130502.sites.decomposed.normalised.common_snps.vcf.bgz --panel_of_normals b37.himut.pon.sbs.dbs.vcf.bgz -o somatic.vcf \n\n## prepare samples for mutational signature extraction\nhimut normcounts --bam aln.primary_alignments.sorted.bam --ref ref.fa --vcf germline.vcf --sample_sbs somatic.vcf -o somatic.normcounts.tsv\nhimut normcounts --bam aln.primary_alignments.sorted.bam --ref ref.fa --vcf germline.vcf --common_snps ALL.wgs.phase3_shapeit2_mvncall_integrated_v5b.20130502.sites.decomposed.normalised.common_snps.vcf.bgz --panel_of_normals b37.himut.pon.sbs.dbs.vcf.bgz --sbs somatic.vcf -o somatic.normcounts.tsv\n```\n\n## Table of Contents\n\n- [Getting Started](#started)\n- [Users\' Guide](#uguide)\n  - [Installation](#install)\n  - [General usage](#general)\n  - [Citing himut](#cite)\n  - [Limitations](#limits)\n\n## <a name="uguide"></a>Users\' Guide\n\nhimut (high-fidelity mutation) is a somatic mutation caller that leverages the base accuracy and read length of Pacific Biosciences (PacBio) CCS reads to call single molecule somatic single-base substitutions (SBS). \n\nA typical somatic mutation caller requires support from multiple reads to determine that a mismatch is a somatic mutation and not a sequencing error. If the read, however, perfectly represents the original DNA molecule and if a mismatch between a read alignment and reference is detected, the mismatch should theoretically reflect the biological process generating the mutation. In addition, the mutational pattern generated from the mismatches should also be concordant with the expected mutational signatures associated with the somatic mutational processes active in the sample. \n\nWe show that PacBio CCS base accuracy is sufficiently accurate to call single molecule somatic SBS and that himut can be used to call these mutations with high confidence.\n\n### <a name="install"></a>Installation\n\nUse pip to install himut:\n\n```sh\npip install himut\n```\n\nDownload and install the latest release:\n\n```sh\nwget https://github.com/sjin09/himut/archive/refs/tags/v1.0.0.tar.gz\ntar -zxvf v1.0.0.tar.gz\ncd himut-1.0.0\nbash install.sh\n```\n\nYou can download and install the source code with the latest developments that might contain code still under development.\n\n```sh\ngit clone https://github.com/sjin09/himut \ncd himut\n/bin/bash install.sh \n````\n\nInstallation through Bioconda will be supported in the future.\n\n### <a name="general"></a>General Usage\n\nhimut accepts as input BAM file with CCS read alignments and VCF file with germline mutations and returns a VCF file with somatic mutations (.vcf suffix is required). himut will also return a VCF file with single molecule somatic single base substitutions (.single_molecule_mutations.vcf) and another VCF file with single molecule double base substitutions (.dbs.vcf), which is experimental and is not for production uses. himut is also able to accept BGZIP compressed VCF files as a more memory-efficient input.\n\nhimut, currently, only accepts minimap2 generated BAM files as `--cs` tag is required for somatic mutation calling. The read alignments must be sorted, compressed and indexed using SAMtools. In addition, secondary and supplementary alignment needs to be removed from the BAM file as deepvariant can only process primary alignments.\n\n```sh\nminimap2 "@RG\\tSM:sample" -ax map-hifi --cs ref.fa pacbio.ccs.fastq.gz | samtools sort -o aln.sorted.bam # SM tag must be provided to retrieve sample ID\nsamtools view -bh -F 0x900 aln.sorted.bam > aln.primary_alignments.sorted.bam # select primary alignments\nsamtools merge *.primary_alignments.sorted.bam | samtools sort -o aln.primary_alignments.mergeSorted.bam -\nsamtools index aln.primary_alignments.sorted.bam\nsamtools index aln.primary_alignments.mergeSorted.bam \n```\n\n#### Create a Panel of Normal VCF file\n\nPanel of Normal VCF file is used to remove substitutions arising from systematic errors. If you wish to generate a separate Panel of Normal VCF file than the one provided, please follow the following step. When the `--create_panel_of_normal` parameter is provided, himut relaxes the hard filter thresholds to maximise the number of mismatches called against the reference genome. \n\n```sh\nhimut call -i aln.primary_alignments.sorted.bam --vcf germline.vcf --common_snps ALL.wgs.phase3_shapeit2_mvncall_integrated_v5b.20130502.sites.decomposed.normalised.common_snps.vcf.bgz --panel_of_normals b37.himut.pon.sbs.dbs.vcf.bgz -o pon.vcf --create_panel_of_normal\n```\n\n#### Haplotype phase heterozygous single nucleotide polymorphisms \n\nCCS reads have an average read length of ~10-20kb and can span a number of heterozygous single nucleotide polymorphisms (hetSNPs). To haplotype phase the hetSNPs, we treat each hetSNP as a node in a graph and as CCS reads are able to span multiple hetSNPs, we are able to count the number of edges between two nodes and determine whether the two nodes belong to the same haplotype. Two or more haplotype consistent nodes are connected to construct a haplotype block across the chromosome and we are able to assign CCS reads to a haplotype block based on their hetSNP composition. If the CCS read belongs to multiple haplotype blocks or if the CCS read does not have a hetSNP, CCS read is determined to be not phased. We would like to highlight that the length of haplotype blocks and the number of phased hetSNPs will be dependent on SNP density, heterozygosity and CCS read length.\n\n```sh\n## use himut to phase CCS reads and to call phased somatic mutations\nhimut phase --bam aln.primary_alignments.sorted.bam --vcf germline.vcf.bgz -o germline.phased.vcf \n```\n\nhetSNPs belonging to the same phase set (PS) in the VCF file belongs to the same haplotype block.\n\n#### call somatic mutations \n\nThe Darwin Tree of Life Project often sequences and assembles one sample per species and hence, we are not able to prepare a VCF file with common SNPs and a Panel of Normal VCF file to remove erroneous substitutions resulting from DNA contamination or systematic errors, respectively. If CCS dataset from multiple samples are not available for the species in question, please use the `--non_human_sample` parameter to indicate the absence of a VCF file with common SNPs and a Panel of Normal VCF file.\n\n```sh\nhimut call -i aln.primary_alignments.sorted.bam --vcf germline.vcf -o somatic.vcf --non_human_sample\n```\n\nWe have selected common SNPs (>1% minor allele frequency) from the 1000 Genomes Project VCF file and prepared a Panel of Normal VCF file against the b37 and the GRCh38 reference genomes using publicly available CCS reads, and the VCF files are available in the Google Drive (https://drive.google.com/drive/folders/14-cSTBocwdyIemXTExuhW-mnTJb87SLT?usp=sharing). \n\n```sh\nhimut call -i aln.primary_alignments.sorted.bam --vcf germline.vcf --common_snps ALL.wgs.phase3_shapeit2_mvncall_integrated_v5b.20130502.sites.decomposed.normalised.common_snps.vcf.bgz --panel_of_normals b37.himut.pon.sbs.dbs.vcf.bgz -o somatic.vcf \n```\n\n#### call haplotype phased somatic mutations\n\nIf the `--phase` parameter is used, VCF file with haplotype phased hetSNPs must be provided to assign CCS reads to a haplotype block. himut will return somatic SBS only from phased CCS reads.\n\n```sh\nhimut call -i aln.primary_alignments.sorted.bam --vcf germline.vcf --phased_vcf germline.phased.vcf -o somatic.phased.vcf --phase --non_human_sample\nhimut call -i aln.primary_alignments.sorted.bam --vcf germline.vcf --phased_vcf germline.phased.vcf --common_snps ALL.wgs.phase3_shapeit2_mvncall_integrated_v5b.20130502.sites.decomposed.normalised.common_snps.vcf.bgz --panel_of_normals b37.himut.pon.sbs.dbs.vcf.bgz -o somatic.vcf --phase \n```\n\n#### SBS96 counts\n\nhimut returns SBS96 counts and a bar-plot of SBS96 counts in the pyrimidine context. \n\n```sh\nhimut sbs96 -i somatic.vcf --ref ref.fa -o somatic.sbs96.tsv \n```\n\n#### SBS96 count normalisation\n\nTo compare SBS96 counts and to extract mutational signatures from multiple samples, SBS96 counts must be normalised against the number of reference genome trinucleotide sequence contexts and the number of callable CCS trinucleotide sequence contexts from which the SBS could have been potentially called. To count the number of callable trinucleotide sequence contexts, the same set of parameters as the one that was used for somatic mutation calling must be used.\n\n```sh\n## non-human sample\nhimut normcounts --bam aln.primary_alignments.sorted.bam --ref ref.fa --vcf germline.vcf --sample_sbs somatic.vcf -o somatic.normcounts.tsv\nhimut normcounts --bam aln.primary_alignments.sorted.bam --ref ref.fa --vcf germline.vcf --phased_vcf germline.phased.vcf --sample_sbs somatic.phased.vcf -o somatic.phased.normcounts.tsv --phase\n## human sample\nhimut normcounts --bam aln.primary_alignments.sorted.bam --ref ref.fa --vcf germline.vcf --common_snps ALL.wgs.phase3_shapeit2_mvncall_integrated_v5b.20130502.sites.decomposed.normalised.common_snps.vcf.bgz --panel_of_normals b37.himut.pon.sbs.dbs.vcf.bgz --sbs somatic.vcf -o somatic.normcounts.tsv\nhimut normcounts --bam aln.primary_alignments.sorted.bam --ref ref.fa --vcf germline.vcf --phased_vcf germline.phased.vcf --common_snps ALL.wgs.phase3_shapeit2_mvncall_integrated_v5b.20130502.sites.decomposed.normalised.common_snps.vcf.bgz --panel_of_normals b37.himut.pon.sbs.dbs.vcf.bgz --sbs somatic.phased.vcf -o somatic.phased.normcounts.tsv --phase\n```\n\n#### DBS78 counts (experimental)\n\nhimut also returns DBS78 counts and a bar-plot of DBS78 counts in pyrimidine context.\n\n```sh\nhimut dbs78 -i somatic.dbs78.vcf -o somatic.dbs78.tsv\n```\n\n### Limitations\n\nPacBio CCS base accuracy is the limiting factor for somatic mutation calling using himut. PacBio circular consensus sequence (pbccs) algorithm calculates the base quality score depending on the dinucleotide sequence context and the number of supporting subread bases. Our research suggests that the base quality score does not correctly reflect the true base accuracy and that the consensus sequence caller does not account for the different substitution error rates in different trinucleotide sequence contexts. We discuss how this issue can be mitigated in our manuscript.\n',
    'author': 'Sangjin Lee',
    'author_email': 'sl17@sanger.ac.uk',
    'maintainer': 'None',
    'maintainer_email': 'sjinlee@pacificbiosciences.com',
    'url': 'https://github.com/sjin09/himut',
    'package_dir': package_dir,
    'packages': packages,
    'package_data': package_data,
    'install_requires': install_requires,
    'entry_points': entry_points,
    'python_requires': '>=3.8,<3.10',
}


setup(**setup_kwargs)

